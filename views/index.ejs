<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat App</title>
<style>
:root {
  --bg-color: #121212;
  --text-color: #fff;
  --header-bg: #075E54;
  --sent-bg: #25D366;
  --recv-bg: #2c2f33;
  --input-bg: #1f1f1f;
  --timestamp-color: #888;
  --btn-edit: #1976d2;
  --btn-delete: #d32f2f;
}
.light {
  --bg-color: #f0f2f5;
  --text-color: #111;
  --header-bg: #128C7E;
  --sent-bg: #128C7E;
  --recv-bg: #e4e6eb;
  --input-bg: #fff;
  --timestamp-color: #555;
  --btn-edit: #1976d2;
  --btn-delete: #d32f2f;
}

body {
  margin:0;
  font-family:'Segoe UI',Tahoma,sans-serif;
  background: var(--bg-color);
  color: var(--text-color);
  display:flex;
  flex-direction:column;
  height:100vh;
}
.header {
  background: var(--header-bg);
  padding:15px 20px;
  font-size:20px;
  font-weight:bold;
  color:#fff;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.header button {background:#fff;color:var(--header-bg);border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-weight:bold;}
.container {flex:1; display:flex; flex-direction:column; max-width:900px; margin:auto; background: var(--bg-color); overflow:hidden;}
#chat-box {flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:15px; scroll-behavior:smooth;}
.chat {max-width:70%; padding:12px 16px; border-radius:18px; position:relative; word-wrap:break-word; animation: fadeIn 0.3s ease-in-out; display:flex; align-items:flex-start; gap:10px;}
.chat.left {align-self:flex-start; background: var(--recv-bg);}
.chat.right {align-self:flex-end; background: var(--sent-bg); color:#fff;}
.chat strong { font-size:12px; opacity:0.8; display:block; margin-bottom:4px;}
.chat p {margin:0; font-size:14px; line-height:1.4; flex:1;}
.timestamp { font-size:11px; color: var(--timestamp-color); margin-top:5px; text-align:right; }

/* Avatar circle with first letter */
.avatar-circle { width:35px; height:35px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:bold; flex-shrink:0; font-size:16px; }

.btn { border:none; padding:5px 10px; border-radius:6px; cursor:pointer; font-size:12px; margin-top:5px; margin-right:5px; transition:.3s; }
.btn.edit { background: var(--btn-edit); color:#fff; }
.btn.edit:hover { background:#0d47a1; }
.btn.danger { background: var(--btn-delete); color:#fff; }
.btn.danger:hover { background:#9a0007; }

#chat-form { display:flex; background: var(--input-bg); padding:12px; gap:10px; align-items:center; position:relative;}
#chat-form input, #chat-form textarea { flex:1; padding:10px; border-radius:20px; border:1px solid #444; font-size:14px; outline:none; resize:none; background: var(--bg-color); color: var(--text-color);}
#chat-form input::placeholder, #chat-form textarea::placeholder { color:#aaa; }
#chat-form button { background: var(--sent-bg); border:none; padding:0 16px; border-radius:50%; color:#fff; font-size:18px; cursor:pointer; transition:.3s; }
#chat-form button:hover { background:#128C7E; }

#emoji-picker { position:absolute; bottom:70px; right:20px; background:#fff; color:#000; border:1px solid #ccc; border-radius:10px; padding:10px; display:none; max-width:250px; max-height:150px; overflow:auto; z-index:100;}
#emoji-picker span { font-size:20px; cursor:pointer; margin:3px; }

#typing { font-size:13px; font-style:italic; color: var(--timestamp-color); margin-left:10px; margin-bottom:5px; }
.search-bar { padding:10px; margin:10px 20px; border-radius:20px; border:none; width:calc(100% - 40px);}
@keyframes fadeIn {from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);}}
.reactions {display:flex; gap:5px; margin-top:5px;}
.reactions span {cursor:pointer; font-size:16px;}
</style>
</head>
<body>

<div class="header">
  ğŸ’¬ Chat App
  <button id="toggleTheme">Toggle Theme</button>
</div>

<div class="container">
  <input type="text" id="search" class="search-bar" placeholder="Search by user name...">

  <div id="chat-box">
    <% chats.forEach(chat => { %>
      <div class="chat <%= chat.from === 'me' ? 'right' : 'left' %>" data-from="<%= chat.from.toLowerCase() %>">
        <div class="avatar-circle" data-name="<%= chat.from %>">
          <%= chat.from.charAt(0).toUpperCase() %>
        </div>
        <div>
          <strong><%= chat.from %> â <%= chat.to %></strong>
          <p><%= chat.msg %></p>
          <div class="timestamp"><%= chat.created_at.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) %></div>
          <div class="reactions">
            <span onclick="addReaction(this,'ğŸ‘')">ğŸ‘</span>
            <span onclick="addReaction(this,'â¤ï¸')">â¤ï¸</span>
            <span onclick="addReaction(this,'ğŸ˜‚')">ğŸ˜‚</span>
          </div>
          <form method="GET" action="/chats/<%= chat._id %>/edit">
            <button class="btn edit">âœï¸ Edit</button>
          </form>
          <form method="POST" action="/chats/<%= chat._id %>?_method=DELETE" onsubmit="return confirm('Are you sure you want to delete this message?');">
            <button class="btn danger">ğŸ—‘ï¸ Delete</button>
          </form>
        </div>
      </div>
    <% }) %>
  </div>
  <div id="typing"></div>

  <div id="emoji-picker">
    <span>ğŸ˜€</span><span>ğŸ˜‚</span><span>ğŸ˜</span><span>ğŸ¥°</span>
    <span>ğŸ‘</span><span>ğŸ‘</span><span>ğŸ˜</span><span>ğŸ¤”</span>
    <span>ğŸ˜¢</span><span>â¤ï¸</span><span>ğŸ”¥</span><span>ğŸ‰</span>
  </div>

  <form id="chat-form" method="POST" action="/chats">
    <button type="button" id="emoji-btn">ğŸ˜Š</button>
    <input type="text" name="from" placeholder="Sender" required>
    <input type="text" name="to" placeholder="Receiver" required>
    <textarea name="msg" placeholder="Type a message..." required></textarea>
    <button type="submit">â¤</button>
  </form>
</div>

<script>
// Theme toggle
const toggleBtn = document.getElementById("toggleTheme");
toggleBtn.addEventListener("click", () => { document.body.classList.toggle("light"); });

// Auto scroll
const chatBox = document.getElementById("chat-box");
chatBox.scrollTop = chatBox.scrollHeight;

// Emoji picker
const emojiBtn = document.getElementById("emoji-btn");
const emojiPicker = document.getElementById("emoji-picker");
const msgInput = document.querySelector('textarea[name="msg"]');
emojiBtn.addEventListener("click", () => {
  emojiPicker.style.display = emojiPicker.style.display === "block" ? "none" : "block";
});
emojiPicker.querySelectorAll("span").forEach(emoji => {
  emoji.addEventListener("click", () => {
    msgInput.value += emoji.innerText;
    emojiPicker.style.display = "none";
    msgInput.focus();
  });
});

// Typing indicator
msgInput.addEventListener("input", () => {
  const typingDiv = document.getElementById("typing");
  typingDiv.innerText = msgInput.value ? `${document.querySelector('input[name="from"]').value || "Someone"} is typing...` : "";
});

// Message reactions
function addReaction(elem, reaction){
  const p = elem.closest('.chat').querySelector('p');
  p.innerText += " " + reaction;
}

// Search / filter by user
const searchInput = document.getElementById("search");
searchInput.addEventListener("input", () => {
  const filter = searchInput.value.toLowerCase();
  document.querySelectorAll("#chat-box .chat").forEach(chat => {
    chat.style.display = chat.dataset.from.includes(filter) ? "flex" : "none";
  });
});

// Set avatar colors
document.querySelectorAll('.avatar-circle').forEach(av => {
  av.style.backgroundColor = stringToColor(av.dataset.name);
});

// Function to generate color from string
function stringToColor(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
  }
  const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
  return "#" + "00000".substring(0, 6 - c.length) + c;
}
</script>

</body>
</html>
